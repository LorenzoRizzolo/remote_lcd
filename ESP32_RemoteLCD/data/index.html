<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RemoteLCD</title>
  <style>
    :root { 
      --bg:#0f172a; 
      --card:#111827; 
      --accent:#22d3ee; 
      --text:#e5e7eb; 
      --muted:#9ca3af; 
    }
    * { 
      box-sizing: border-box; 
    }
    body { 
      margin:0; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; 
      /* background:linear-gradient(120deg,#0f172a,#1f2937);  */
      background-color: #1f2937;
      color:var(--text); 
      min-height:100vh; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
    }
    .container { 
      width:100%; 
      max-width:780px; 
      padding:24px; 
    }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; box-shadow: 0 10px 25px rgba(0,0,0,.35); overflow:hidden; }
    header { padding:24px 24px 0; }
    h1 { margin:0; font-size:28px; letter-spacing:.3px; display:flex; align-items:center; gap:10px; }
    .chip { 
      padding:4px 10px; 
      border-radius:999px; 
      background:#0b1220; 
      border:1px solid #1f2937; 
      color:var(--muted); 
      font-size:12px; 
      text-align: center;
    }
    main { display:grid; grid-template-columns: 1fr 1fr; gap:18px; padding:24px; }
    .stat { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:18px; }
    .stat h2 { margin:0 0 6px; font-size:14px; color:var(--muted); }
    .value { font-size:32px; font-weight:700; }
    .value small { font-size:18px; color:var(--muted); margin-left:6px; }
    .form { 
      grid-column: 1 / -1; 
      background:#0b1220; 
      border:1px solid #1f2937; 
      border-radius:12px; 
      padding:18px;
      display:grid; 
      grid-template-columns: 1fr auto; 
      gap:12px; 
    }
    input[type="text"] { width:100%; background:#0f172a; color:var(--text); border:1px solid #233147; border-radius:10px; padding:12px 14px; outline:none; font-size:16px; }
    input[type="text"]::placeholder { color:#6b7280; }
    button { background:var(--accent); color:#04212a; font-weight:700; border:none; border-radius:10px; padding:12px 16px; cursor:pointer; box-shadow:0 8px 18px rgba(34,211,238,.25); }
    button:active { transform: translateY(1px); }
    footer { padding:0 24px 24px; color:var(--muted); font-size:12px; }
    .message { 
      /* margin-top:6px;  */
      color:#a3e635; 
      font-size:13px; }
    @media (max-width:720px) { main { grid-template-columns: 1fr; } }
    .wifi { display:flex; align-items:center; gap:10px; }
    .wifi .ssid { font-size:14px; color:var(--muted); }
    .wifi-bars { display:inline-flex; gap:3px; align-items:flex-end; height:16px; }
    .wifi-bars span { width:4px; background:#233147; border-radius:2px; display:block; }
    .wifi-bars span.on { background:var(--accent); }
  </style>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#22d3ee">
  <link rel="shortcut icon" href="icons/ESP32.png" type="image/x-icon">
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>
          ESP32 Remote LCD
          <span class="chip">Web UI</span>
        </h1>
      </header>
      <main>
        <div class="stat">
          <h2>Ambiente</h2>
          <div class="value"><span id="temp">—</span><small>°C</small></div>
          <div style="margin-top:8px" class="value"><span id="hum">—</span><small>%</small></div>
        </div>
        <div class="stat">
          <h2>Data e Ora</h2>
          <div class="value"><span id="date">—</span></div>
          <div style="margin-top:8px" class="value"><span id="time">—</span></div>
        </div>
        <div class="stat">
          <h2>Wi‑Fi</h2>
          <div class="wifi">
            <div class="wifi-bars" id="wifiBars">
              <span></span><span></span><span></span><span></span>
            </div>
            <div class="ssid"><span id="wifiSsid">—</span> • <span id="wifiRssi">—</span> dBm</div>
          </div>
        </div>
        <div class="stat">
          <h2>Messaggio attuale</h2>
          <div id="current" class="value">—</div>
        </div>
        <form class="form" id="form">
          <input id="msg" type="text" placeholder="Scrivi un nuovo messaggio" />
          <button type="submit">Invia</button>
          <div id="result" class="message"></div>
        </form>
      </main>
    </div>
  </div>
  <script>
    function setWifiBars(rssi){
      // Map RSSI to 0-4 bars
      let bars = 0;
      if (typeof rssi === 'number') {
        if (rssi >= -55) bars = 4; else if (rssi >= -65) bars = 3; else if (rssi >= -75) bars = 2; else if (rssi >= -85) bars = 1; else bars = 0;
      }
      const container = document.getElementById('wifiBars');
      if (!container) return;
      [...container.children].forEach((el, i) => {
        el.className = i < bars ? 'on' : '';
        el.style.height = `${4 + i*3}px`;
      });
    }

    async function refresh() {
      try {
        const r = await fetch('/status');
        const j = await r.json();
        document.getElementById('current').textContent = j.message || '—';
        document.getElementById('temp').textContent = j.temperature ?? '—';
        document.getElementById('hum').textContent = j.humidity ?? '—';
        const ts = j.time || '';
        const [dateStr, timeStr] = ts.includes(' ') ? ts.split(' ') : ['', ''];
        document.getElementById('date').textContent = dateStr || '—';
        document.getElementById('time').textContent = (timeStr || '').slice(0,5) || '—';
        document.getElementById('wifiSsid').textContent = (j.ssid || '—');
        document.getElementById('wifiRssi').textContent = (typeof j.rssi !== 'undefined' ? j.rssi : '—');
        setWifiBars(j.rssi);
      } catch (e) { console.log(e); }
    }

    document.getElementById('form').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const msg = document.getElementById('msg').value.trim();
      if (!msg) return;
      const r = await fetch('/update?msg=' + encodeURIComponent(msg));
      const t = await r.text();
      document.getElementById('result').textContent = t;
      document.getElementById('msg').value = '';
      setTimeout(() => { document.getElementById('result').textContent = ''; }, 5000);
      refresh();
    });

    refresh();
    setInterval(refresh, 2000);
  </script>
</body>
</html>
